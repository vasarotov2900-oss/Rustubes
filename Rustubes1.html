<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Rustubes 2025 - IndexedDB Edition</title>
    <style>
        :root { --bg: #0f0f0f; --text: #fff; --accent: #ff0000; --card: #272727; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: #0f0f0f; border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 1000; }
        .logo { font-size: 24px; font-weight: bold; color: var(--accent); text-decoration: none; cursor: pointer; }
        .search-box { flex: 0 1 500px; display: flex; background: #121212; border: 1px solid #333; border-radius: 40px; padding: 5px 15px; }
        .search-box input { background: transparent; border: none; color: white; width: 100%; outline: none; padding: 5px; }
        .container { padding: 20px; max-width: 1200px; margin: auto; }
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .video-card { background: var(--card); border-radius: 12px; cursor: pointer; overflow: hidden; position: relative; }
        .thumb { width: 100%; aspect-ratio: 16/9; background: #333; object-fit: cover; }
        #player-page { display: none; }
        .video-box { width: 100%; background: #000; border-radius: 12px; aspect-ratio: 16/9; overflow: hidden; }
        video { width: 100%; height: 100%; }
        button { padding: 8px 16px; border-radius: 20px; border: none; cursor: pointer; font-weight: bold; }
        .btn-red { background: var(--accent); color: white; }
        .btn-gray { background: var(--card); color: white; border: 1px solid #444; }
        .modal { background: var(--card); padding: 25px; border-radius: 15px; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; width: 350px; display: none; border: 1px solid #444; }
        .modal input, .modal textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #444; background: #121212; color: white; box-sizing: border-box; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1500; display: none; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; cursor: pointer; }
        .hidden { display: none !important; }
        .comment-item { margin-bottom: 12px; border-left: 2px solid var(--accent); padding-left: 12px; }
    </style>
</head>
<body>

<header>
    <div class="logo" onclick="location.reload()">Rustubes</div>
    <div class="search-box"><input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –≤–∏–¥–µ–æ –∏–ª–∏ –∞–≤—Ç–æ—Ä–æ–≤..." oninput="runSearch()"></div>
    <div id="guest-nav"><button class="btn-gray" onclick="openM('auth-modal')">–í–æ–π—Ç–∏</button></div>
    <div id="user-nav" class="hidden">
        <div style="display:flex; align-items:center; gap:15px;">
            <button class="btn-red" onclick="openM('upload-modal')">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            <img id="header-av" class="avatar" onclick="openM('prof-modal')">
            <button class="btn-gray" onclick="logout()">–í—ã—Ö–æ–¥</button>
        </div>
    </div>
</header>

<div class="container">
    <div id="feed-page">
        <h2 id="feed-title">–í—Å–µ –≤–∏–¥–µ–æ</h2>
        <div class="video-grid" id="v-grid"></div>
    </div>

    <div id="player-page">
        <button class="btn-gray" onclick="location.reload()">‚Üê –ù–∞–∑–∞–¥</button>
        <div class="video-box" style="margin-top:20px;"><video id="v-obj" controls autoplay></video></div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px;">
            <h1 id="v-title" style="margin:0;"></h1>
            <div id="v-admin-tools"></div>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
            <div style="display:flex; align-items:center; gap:10px;">
                <img id="v-author-av" class="avatar"><b id="v-author-name"></b>
            </div>
            <div>
                <button class="btn-gray" onclick="handleVote(1)">üëç <span id="l-cnt">0</span></button>
                <button class="btn-gray" onclick="handleVote(-1)">üëé <span id="d-cnt">0</span></button>
                <button class="btn-red" onclick="downloadVideo()">üì• –°–∫–∞—á–∞—Ç—å</button>
            </div>
        </div>
        <div id="v-desc" style="background:var(--card); padding:15px; border-radius:12px; margin-top:15px; white-space:pre-wrap; color:#ccc;"></div>
        <hr style="border:0; border-top:1px solid #333; margin:30px 0;">
        <div id="comment-form-box" class="hidden">
            <input type="text" id="c-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." style="width:80%; padding:12px; background:transparent; border:1px solid #333; color:white; border-radius:8px;">
            <button class="btn-red" onclick="addComment()">–û–ö</button>
        </div>
        <div id="c-list" style="margin-top:20px;"></div>
    </div>
</div>

<div id="overlay" class="overlay" onclick="closeM()"></div>

<!-- –ú–æ–¥–∞–ª–∫–∏ -->
<div id="auth-modal" class="modal">
    <div style="display:flex; gap:10px; margin-bottom:15px;">
        <button id="t-login" style="flex:1" class="btn-red" onclick="setAuthMode('login')">–í—Ö–æ–¥</button>
        <button id="t-reg" style="flex:1" class="btn-gray" onclick="setAuthMode('reg')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>
    <div id="auth-error" style="color:red; font-size:12px; margin-bottom:10px;"></div>
    <input type="text" id="auth-name" placeholder="–ò–º—è">
    <input type="password" id="auth-pass" placeholder="–ü–∞—Ä–æ–ª—å">
    <button class="btn-red" id="auth-btn" style="width:100%" onclick="processAuth()">–í–æ–π—Ç–∏</button>
</div>

<div id="prof-modal" class="modal">
    <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
    <input type="text" id="p-new-name" placeholder="–ù–æ–≤–æ–µ –∏–º—è">
    <input type="text" id="p-new-av" placeholder="URL –∞–≤–∞—Ç–∞—Ä–∞">
    <button class="btn-red" style="width:100%" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

<div id="upload-modal" class="modal">
    <h3>–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ</h3>
    <div id="upload-status" style="font-size:12px; color:yellow;"></div>
    <input type="file" id="f-file" accept="video/*">
    <input type="text" id="f-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
    <textarea id="f-desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
    <input type="text" id="f-poster" placeholder="URL –ø—Ä–µ–≤—å—é">
    <button class="btn-red" id="pub-btn" style="width:100%" onclick="publishVideo()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
</div>

<script>
    let db;
    let currentUser = JSON.parse(sessionStorage.getItem('rt_session')) || null;
    let authMode = 'login';
    let activeVid = null;
    let allVideos = [];

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è IndexedDB –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¢–Ø–ñ–ï–õ–´–• –≤–∏–¥–µ–æ
    const request = indexedDB.open("RustubesDB", 1);
    request.onupgradeneeded = e => {
        db = e.target.result;
        db.createObjectStore("videos", { keyPath: "id" });
        db.createObjectStore("users", { keyPath: "name" });
    };
    request.onsuccess = e => {
        db = e.target.result;
        loadAll();
    };

    function loadAll() {
        const transaction = db.transaction(["videos"], "readonly");
        const store = transaction.objectStore("videos");
        const req = store.getAll();
        req.onsuccess = () => {
            allVideos = req.result.reverse();
            renderVideos(allVideos);
            if(currentUser) setupUI();
        };
    }

    function setupUI() {
        document.getElementById('guest-nav').classList.add('hidden');
        document.getElementById('user-nav').classList.remove('hidden');
        document.getElementById('comment-form-box').classList.remove('hidden');
        document.getElementById('header-av').src = currentUser.avatar;
    }

    // --- –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –ò –í–•–û–î (–ü–û–ß–ò–ù–ï–ù–û) ---
    function setAuthMode(m) {
        authMode = m;
        document.getElementById('t-login').className = m === 'login' ? 'btn-red' : 'btn-gray';
        document.getElementById('t-reg').className = m === 'reg' ? 'btn-red' : 'btn-gray';
        document.getElementById('auth-btn').innerText = m === 'login' ? '–í–æ–π—Ç–∏' : '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç';
    }

    function processAuth() {
        const name = document.getElementById('auth-name').value.trim();
        const pass = document.getElementById('auth-pass').value;
        if(!name || !pass) return;

        const transaction = db.transaction(["users"], "readwrite");
        const store = transaction.objectStore("users");

        if(authMode === 'reg') {
            const newUser = { name, pass, avatar: 'api.dicebear.com' + name };
            const req = store.add(newUser);
            req.onsuccess = () => { alert("–£—Å–ø–µ—Ö! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ."); setAuthMode('login'); };
            req.onerror = () => { document.getElementById('auth-error').innerText = "–ò–º—è –∑–∞–Ω—è—Ç–æ!"; };
        } else {
            const req = store.get(name);
            req.onsuccess = () => {
                const u = req.result;
                if(u && u.pass === pass) {
                    sessionStorage.setItem('rt_session', JSON.stringify(u));
                    location.reload();
                } else {
                    document.getElementById('auth-error').innerText = "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞!";
                }
            };
        }
    }

    function logout() { sessionStorage.clear(); location.reload(); }

    // --- –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø (–ü–û–ß–ò–ù–ï–ù–û –ß–ï–†–ï–ó INDEXEDDB) ---
    function publishVideo() {
        const file = document.getElementById('f-file').files[0];
        const title = document.getElementById('f-title').value.trim();
        if(!file || !title) return alert("–§–∞–π–ª –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã!");

        document.getElementById('pub-btn').disabled = true;
        document.getElementById('upload-status').innerText = "–ó–∞–≥—Ä—É–∑–∫–∞ –≤ –±–∞–∑—É –±—Ä–∞—É–∑–µ—Ä–∞ (IndexedDB)...";

        const reader = new FileReader();
        reader.onload = function(e) {
            const newVid = {
                id: Date.now(),
                title: title,
                desc: document.getElementById('f-desc').value,
                blob: e.target.result, // –•—Ä–∞–Ω–∏–º —Å–∞–º–æ –≤–∏–¥–µ–æ
                poster: document.getElementById('f-poster').value || "cdn-icons-png.flaticon.com",
                author: currentUser.name,
                av: currentUser.avatar,
                likes: [], dislikes: [], comments: []
            };

            const transaction = db.transaction(["videos"], "readwrite");
            transaction.objectStore("videos").add(newVid);
            transaction.oncomplete = () => location.reload();
        };
        reader.readAsArrayBuffer(file);
    }

    function renderVideos(list) {
        const grid = document.getElementById('v-grid');
        grid.innerHTML = list.map(v => `
            <div class="video-card" onclick="openVideo(${v.id})">
                <img src="${v.poster}" class="thumb">
                <div style="padding:12px; display:flex; gap:10px;">
                    <img src="${v.av}" class="avatar" style="width:30px; height:30px;">
                    <div><b>${v.title}</b><br><small style="color:#aaa">${v.author}</small></div>
                </div>
            </div>
        `).join('');
    }

    function openVideo(id) {
        activeVid = allVideos.find(v => v.id === id);
        document.getElementById('feed-page').classList.add('hidden');
        document.getElementById('player-page').style.display = 'block';
        
        // –°–æ–∑–¥–∞–µ–º URL –∏–∑ ArrayBuffer –¥–ª—è –ø–ª–µ–µ—Ä–∞
        const blob = new Blob([activeVid.blob], { type: 'video/mp4' });
        const url = URL.createObjectURL(blob);
        const vid = document.getElementById('v-obj');
        vid.src = url;
        vid.play();

        document.getElementById('v-title').innerText = activeVid.title;
        document.getElementById('v-desc').innerText = activeVid.desc || "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è";
        document.getElementById('v-author-name').innerText = activeVid.author;
        document.getElementById('v-author-av').src = activeVid.av;

        const tools = document.getElementById('v-admin-tools');
        tools.innerHTML = (currentUser && activeVid.author === currentUser.name) 
            ? `<button class="btn-gray" style="color:red" onclick="deleteVideo(${activeVid.id})">–£–¥–∞–ª–∏—Ç—å –≤–∏–¥–µ–æ</button>` : '';
        updateUI();
    }

    function deleteVideo(id) {
        if(!confirm("–£–¥–∞–ª–∏—Ç—å?")) return;
        const transaction = db.transaction(["videos"], "readwrite");
        transaction.objectStore("videos").delete(id);
        transaction.oncomplete = () => location.reload();
    }

    function downloadVideo() {
        const blob = new Blob([activeVid.blob], { type: 'video/mp4' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = activeVid.title + ".mp4";
        a.click();
    }

    function runSearch() {
        const q = document.getElementById('search-input').value.toLowerCase();
        const filtered = allVideos.filter(v => v.title.toLowerCase().includes(q) || v.author.toLowerCase().includes(q));
        renderVideos(filtered);
    }

    // --- –ö–û–ú–ú–ï–ù–¢–´ –ò –õ–ê–ô–ö–ò ---
    function addComment() {
        const t = document.getElementById('c-input').value;
        if(!t) return;
        activeVid.comments.push({ u: currentUser.name, t, id: Date.now() });
        saveActive();
    }

    function deleteComment(cid) {
        activeVid.comments = activeVid.comments.filter(c => c.id !== cid);
        saveActive();
    }

    function handleVote(t) {
        if(!currentUser) return alert("–í–æ–π–¥–∏—Ç–µ!");
        const n = currentUser.name;
        if(t === 1) {
            if(activeVid.likes.includes(n)) activeVid.likes = activeVid.likes.filter(x => x !== n);
            else { activeVid.likes.push(n); activeVid.dislikes = activeVid.dislikes.filter(x => x !== n); }
        } else {
            if(activeVid.dislikes.includes(n)) activeVid.dislikes = activeVid.dislikes.filter(x => x !== n);
            else { activeVid.dislikes.push(n); activeVid.likes = activeVid.likes.filter(x => x !== n); }
        }
        saveActive();
    }

    function saveActive() {
        const transaction = db.transaction(["videos"], "readwrite");
        transaction.objectStore("videos").put(activeVid);
        transaction.oncomplete = () => { updateUI(); };
    }

    function updateUI() {
        document.getElementById('l-cnt').innerText = activeVid.likes.length;
        document.getElementById('d-cnt').innerText = activeVid.dislikes.length;
        document.getElementById('c-list').innerHTML = activeVid.comments.map(c => {
            const canDel = currentUser && (c.u === currentUser.name || activeVid.author === currentUser.name);
            return `<div class="comment-item"><b>${c.u}</b>: ${c.t} ${canDel ? `<br><small style="color:red;cursor:pointer" onclick="deleteComment(${c.id})">–£–¥–∞–ª–∏—Ç—å</small>` : ''}</div>`;
        }).join('');
    }

    function openM(id) { document.getElementById('overlay').style.display='block'; document.getElementById(id).style.display='block'; }
    function closeM() { document.getElementById('overlay').style.display='none'; document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }
    
    function saveProfile() {
        const n = document.getElementById('p-new-name').value || currentUser.name;
        const a = document.getElementById('p-new-av').value || currentUser.avatar;
        const oldName = currentUser.name;
        currentUser.name = n; currentUser.avatar = a;
        const transaction = db.transaction(["users"], "readwrite");
        const store = transaction.objectStore("users");
        if(n !== oldName) store.delete(oldName);
        store.put(currentUser);
        transaction.oncomplete = () => { sessionStorage.setItem('rt_session', JSON.stringify(currentUser)); location.reload(); };
    }

</script>
</body>
</html>
